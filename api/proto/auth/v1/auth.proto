syntax = "proto3";

package auth.v1;

option go_package = "github.com/pguia/auth/api/proto/auth/v1;authv1";

import "google/protobuf/timestamp.proto";

// ============================================
// Auth Service Definition
// ============================================
service AuthService {
  // Email/Password Authentication
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
  rpc Logout(LogoutRequest) returns (LogoutResponse);
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse);
  rpc ForgotPassword(ForgotPasswordRequest) returns (ForgotPasswordResponse); 
  rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse);
  
  // 2FA/TOTP Management
  rpc Enable2FA(Enable2FARequest) returns (Enable2FAResponse);
  rpc Verify2FA(Verify2FARequest) returns (Verify2FAResponse);
  rpc Disable2FA(Disable2FARequest) returns (Disable2FAResponse);
  rpc Generate2FABackupCodes(Generate2FABackupCodesRequest) returns (Generate2FABackupCodesResponse);
  
  // Passwordless Authentication
  rpc SendPasswordlessEmail(SendPasswordlessEmailRequest) returns (SendPasswordlessEmailResponse);
  rpc VerifyPasswordlessToken(VerifyPasswordlessTokenRequest) returns (VerifyPasswordlessTokenResponse);
  
  // OAuth
  rpc GetOAuthURL(GetOAuthURLRequest) returns (GetOAuthURLResponse);
  rpc OAuthCallback(OAuthCallbackRequest) returns (OAuthCallbackResponse);
  rpc LinkOAuthAccount(LinkOAuthAccountRequest) returns (LinkOAuthAccountResponse);
  rpc UnlinkOAuthAccount(UnlinkOAuthAccountRequest) returns (UnlinkOAuthAccountResponse);
  
  // Token & Session Management
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);
  rpc RevokeToken(RevokeTokenRequest) returns (RevokeTokenResponse);
  rpc GetActiveSessions(GetActiveSessionsRequest) returns (GetActiveSessionsResponse);
  rpc RevokeSession(RevokeSessionRequest) returns (RevokeSessionResponse);
  
  // User Management
  rpc GetUserProfile(GetUserProfileRequest) returns (GetUserProfileResponse);
  rpc UpdateUserProfile(UpdateUserProfileRequest) returns (UpdateUserProfileResponse);
  rpc VerifyEmail(VerifyEmailRequest) returns (VerifyEmailResponse);
  rpc ResendVerificationEmail(ResendVerificationEmailRequest) returns (ResendVerificationEmailResponse);
}

// ============================================
// Messages - Registration & Login
// ============================================
message RegisterRequest {
  string email = 1;
  string password = 2;
  string first_name = 3;
  string last_name = 4;
  map<string, string> metadata = 5;
}

message RegisterResponse {
  string user_id = 1;
  string email = 2;
  bool email_verified = 3;
  string message = 4;
}

message LoginRequest {
  string email = 1;
  string password = 2;
  string totp_code = 3; // Optional, required if 2FA is enabled
  string device_id = 4;
  string device_name = 5;
}

message LoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
  bool requires_2fa = 5; // If true, client must call Verify2FA
  string session_id = 6;
}

message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
}

message LogoutRequest {
  string session_id = 1;
}

message LogoutResponse {
  bool success = 1;
  string message = 2;
}

message ChangePasswordRequest {
  string user_id = 1;
  string current_password = 2;
  string new_password = 3;
}

message ChangePasswordResponse {
  bool success = 1;
  string message = 2;
}

message ForgotPasswordRequest {
  string email = 1;
}

message ForgotPasswordResponse {
  bool success = 1;
  string message = 2;
}


message ResetPasswordRequestResponse {
  bool success = 1;
  string message = 2;
}

message ResetPasswordRequest {
  string token = 1;
  string new_password = 2;
}

message ResetPasswordResponse {
  bool success = 1;
  string message = 2;
}

// ============================================
// Messages - 2FA/TOTP
// ============================================
message Enable2FARequest {
  string user_id = 1;
}

message Enable2FAResponse {
  string secret = 1;
  string qr_code_url = 2;
  repeated string backup_codes = 3;
}

message Verify2FARequest {
  string user_id = 1;
  string totp_code = 2;
  string session_id = 3; // For completing login flow
}

message Verify2FAResponse {
  bool verified = 1;
  string access_token = 2; // Returned after successful 2FA during login
  string refresh_token = 3;
  int64 expires_in = 4;
  string message = 5;
}

message Disable2FARequest {
  string user_id = 1;
  string password = 2;
  string totp_code = 3;
}

message Disable2FAResponse {
  bool success = 1;
  string message = 2;
}

message Generate2FABackupCodesRequest {
  string user_id = 1;
  string password = 2;
}

message Generate2FABackupCodesResponse {
  repeated string backup_codes = 1;
}

// ============================================
// Messages - Passwordless Authentication
// ============================================
message SendPasswordlessEmailRequest {
  string email = 1;
  string redirect_url = 2; // Optional callback URL
}

message SendPasswordlessEmailResponse {
  bool success = 1;
  string message = 2;
  int64 expires_in = 3;
}

message VerifyPasswordlessTokenRequest {
  string token = 1;
  string device_id = 2;
  string device_name = 3;
}

message VerifyPasswordlessTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
  string session_id = 5;
}

// ============================================
// Messages - OAuth
// ============================================
message GetOAuthURLRequest {
  OAuthProvider provider = 1;
  string redirect_uri = 2;
  string state = 3;
  repeated string scopes = 4;
}

message GetOAuthURLResponse {
  string auth_url = 1;
  string state = 2;
}

message OAuthCallbackRequest {
  OAuthProvider provider = 1;
  string code = 2;
  string state = 3;
  string redirect_uri = 4;
  string device_id = 5;
  string device_name = 6;
}

message OAuthCallbackResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
  bool is_new_user = 5;
  string session_id = 6;
}

message LinkOAuthAccountRequest {
  string user_id = 1;
  OAuthProvider provider = 2;
  string code = 3;
  string state = 4;
}

message LinkOAuthAccountResponse {
  bool success = 1;
  string message = 2;
  OAuthAccount oauth_account = 3;
}

message UnlinkOAuthAccountRequest {
  string user_id = 1;
  OAuthProvider provider = 2;
}

message UnlinkOAuthAccountResponse {
  bool success = 1;
  string message = 2;
}

// ============================================
// Messages - Token & Session Management
// ============================================
message ValidateTokenRequest {
  string access_token = 1;
}

message ValidateTokenResponse {
  bool valid = 1;
  string user_id = 2;
  string email = 3;
  map<string, string> claims = 4;
  google.protobuf.Timestamp expires_at = 5;
}

message RevokeTokenRequest {
  string token = 1;
  TokenType token_type = 2;
}

message RevokeTokenResponse {
  bool success = 1;
  string message = 2;
}

message GetActiveSessionsRequest {
  string user_id = 1;
}

message GetActiveSessionsResponse {
  repeated Session sessions = 1;
}

message RevokeSessionRequest {
  string user_id = 1;
  string session_id = 2;
}

message RevokeSessionResponse {
  bool success = 1;
  string message = 2;
}

// ============================================
// Messages - User Management
// ============================================
message GetUserProfileRequest {
  string user_id = 1;
}

message GetUserProfileResponse {
  User user = 1;
}

message UpdateUserProfileRequest {
  string user_id = 1;
  string first_name = 2;
  string last_name = 3;
  string phone_number = 4;
  map<string, string> metadata = 5;
}

message UpdateUserProfileResponse {
  User user = 1;
}

message VerifyEmailRequest {
  string token = 1;
}

message VerifyEmailResponse {
  bool success = 1;
  string message = 2;
}

message ResendVerificationEmailRequest {
  string email = 1;
}

message ResendVerificationEmailResponse {
  bool success = 1;
  string message = 2;
}

// ============================================
// Common Models
// ============================================
message User {
  string id = 1;
  string email = 2;
  bool email_verified = 3;
  string first_name = 4;
  string last_name = 5;
  string phone_number = 6;
  bool two_factor_enabled = 7;
  repeated OAuthAccount oauth_accounts = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
  google.protobuf.Timestamp last_login_at = 11;
  map<string, string> metadata = 12;
}

message Session {
  string id = 1;
  string user_id = 2;
  string device_id = 3;
  string device_name = 4;
  string ip_address = 5;
  string user_agent = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp last_accessed_at = 8;
  google.protobuf.Timestamp expires_at = 9;
  bool is_current = 10;
}

message OAuthAccount {
  OAuthProvider provider = 1;
  string provider_user_id = 2;
  string email = 3;
  google.protobuf.Timestamp linked_at = 4;
}

// ============================================
// Enums
// ============================================
enum OAuthProvider {
  OAUTH_PROVIDER_UNSPECIFIED = 0;
  OAUTH_PROVIDER_GOOGLE = 1;
  OAUTH_PROVIDER_GITHUB = 2;
  OAUTH_PROVIDER_FACEBOOK = 3;
  OAUTH_PROVIDER_APPLE = 4;
  OAUTH_PROVIDER_MICROSOFT = 5;
  OAUTH_PROVIDER_DISCORD = 6;
}

enum TokenType {
  TOKEN_TYPE_UNSPECIFIED = 0;
  TOKEN_TYPE_ACCESS = 1;
  TOKEN_TYPE_REFRESH = 2;
}